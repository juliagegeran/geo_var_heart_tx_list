---
title: Data prep for *Practice Changes at U.S. Transplant Centers After the New Adult Heart Allocation Policy*
author: "Julia Ran, William Parker"
output:
  rmdformats::material:
    highlight: tango
  html_document:
    theme: cosmo
    toc: yes
---

# Loading in packages 

This chunk is used to load in the packages in R that help us to tidy, manipulate, and visualize the data. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

require("knitr")
opts_knit$set(root.dir = "C:/Users/julia/Google Drive/Pritzker/SRP/Codes/SAF SAS files")

```


```{r library}
library(tidyverse)
library(haven)
library(rmdformats)
library(dplyr)
```

# Data sources

Standard Scientific Registry of Transplant Recipients (SRTR) SAF files
We uploaded all the relevant files that contained data for the study.


```{r data_in}
# read in the SRTR SAF files
##all thoracic transplant candidate information
cand_thor <- read_sas("cand_thor.sas7bdat", NULL) %>%  
  zap_formats() %>% zap_labels()

#justification for status 1a
statjust_hr1a <- read_sas("statjust_hr1a.sas7bdat", NULL) %>%
  zap_formats() %>% zap_labels()

#justification for status 1b
statjust_hr1b <- read_sas("statjust_hr1b.sas7bdat", NULL) %>%
  zap_formats() %>% zap_labels()

#transplant result
tx_hr <- read_sas("tx_hr.sas7bdat", NULL) %>%  
  zap_formats() %>% zap_labels()

#center-level and opo-level predictors 
institution <- read_sas("institution.sas7bdat", NULL) %>%  
  zap_formats() %>% zap_labels()

opo <- read_sas("hist_opo_txc.sas7bdat", NULL) %>% 
  zap_formats() %>% zap_labels()

donor <- read_sas("donor_deceased.sas7bdat",NULL) %>% 
  zap_formats() %>%  zap_labels()

```

```{r new justification}
#justification for new statuses
setwd("C:/Users/julia/Google Drive/Pritzker/SRP/Codes/post_justification")

#justification for new status 1
statjust_hr1 <- read.csv("JustFormHRStat1.csv")

#justification for new status 2
statjust_hr2 <- read.csv("JustFormHRStat2.csv") 

#justification for new status 3
statjust_hr3 <- read.csv("JustFormHRStat3.csv") 

#justification for new status 4
statjust_hr4 <- read.csv("JustFormHRStat4.csv") 


#status justification and episodes
StatusJustEpisode <- read.csv("StatusJustEpisode.csv") 

#linking WlregAuditID to justification ID
JustFormHRDataLink <- read.csv("JustFormHRDataLink.csv") 

#linking WlregAuditID to Px_ID, the linking is copied from RiskStratDataHR
WlregAuditId_PxId <- read.csv("WlregAuditId_PxId.csv",col.names = c("WlregAuditId","px_id"))

#JustFormHR

setwd("C:/Users/julia/Google Drive/Pritzker/SRP/Codes/post_justification")
JustFormHR <- read.csv("JustFormHR.csv")
```


# Select study sample

## Define data ranges

This section specifics the dates used in the study. The dates can be modified by changing the date in this chunk of code. The only constraint is that the start date must be after 10-18-2018 to work properly to generate even cohorts.

```{r data_ranges}

start_date <- as.Date("2016-12-01")
end_date <- as.Date("2020-02-28")

#mark the end of the pre-policy cohort
pre_policy_end_date <- as.Date("2018-02-28")


#mark the start of the post-policy cohort
post_policy_start_date <- as.Date("2018-12-01")

policy_switch_date <- as.Date("2018-10-18")
```

##Filter initial listing

```{r filter initial listing}
#keep multi-organ recipients to code as Status 5
multi <- TRUE

#exclude candidates <18 at the time of listing
peds <- FALSE

init_list <- cand_thor %>% 
   mutate(list_date = CAN_LISTING_DT) %>% 
    filter(list_date >= start_date & list_date <= end_date & WL_ORG == "HR")  %>% 
  mutate(status = CAN_INIT_STAT, 
         center = CAN_LISTING_CTR_ID,
         date_start = list_date) %>% 
  filter(CAN_AGE_AT_LISTING >17)


multi_recips <- tx_hr %>% filter(REC_TX_TY == 2 | REC_TX_TY ==4) %>% dplyr::select(PX_ID,REC_TX_TY)

#number of multi-organ recipients
n_mults <- nrow(init_list %>% filter(PX_ID %in% multi_recips$PX_ID))

#exclude them from the init_list because we don't actually care
# <- init_list %>% filter(!PX_ID %in% multi_recips$PX_ID)

remove(multi_recips)

#filter out inactives 
init_list <- init_list %>%
  filter(CAN_INIT_STAT %in% 
           c(2010, 2020, 2030,  
             2110, 2120, 2130, 
             2140, 2150, 2160)) 

```


# Classify pre-policy listings as Status 1-6
We reclassified the pre-policy cohort into the new priority system tiers. Following the approach taken during OPTN simulation modeling, we assigned each candidate in the pre-policy cohort a status by applying the new heart allocation policy retrospectively based on the candidateâ€™s old priority system status justification, listing diagnosis, and hemodynamics. 

## Status 1A -> Status 1-4

```{r status_1A_clean_and_classify}
#select pre-policy listings
status_1a <- init_list %>% 
  filter(list_date < policy_switch_date & CAN_INIT_STAT == 2010)

just_1a <- statjust_hr1a %>%
    filter(PX_ID %in% status_1a$PX_ID) %>%
    arrange(PX_ID, CANHX_CHG_DT) 

#remove redundant or erroneous justifications
just_1a <- distinct(just_1a) %>%
  filter(CANHX_FORM_STAT == 4 | CANHX_FORM_STAT == 8) %>%
  distinct(PX_ID, CANHX_CHG_DT, .keep_all = TRUE)

#select key variables
just_1a <- just_1a %>% 
  dplyr::select(PX_ID, 
         CAN_LISTING_CTR_ID, CANHX_CHG_DT,
    CANHX_STAT_TY, 
    CANHX_FORM_STAT, 
    CANHX_DIALYSIS, 
    CANHX_LAB_SERUM_CREAT, 
    CANHX_ADULT_CRITERIA_A, 
    CANHX_ADULT_CRITERIA_B, 
    CANHX_ADULT_CRITERIA_C, 
    CANHX_ADULT_CRITERIA_D, 
    CANHX_ADULT_CRITERIA_E, 
    CANHX_INTRP_DOBU, 
    CANHX_INTRP_DOPA, 
    CANHX_INTRP_MILRIN,
    CANHX_ADMITTED, 
    CANHX_IABP, 
    CANHX_ECMO, 
    CANHX_LVAD_TYPE, 
    CANHX_VAD, 
    CANHX_TAH, 
    CANHX_RVAD_TYPE,
    CANHX_LAB_BILI, 
    CANHX_HEMO_SBP, 
    CANHX_CARD_OUTPUT, 
    CANHX_HEMO_CI, 
    CANHX_HEMO_INTRP_OBTAINED, 
    CANHX_HEMO_BSA,
    CANHX_HEMO_PCWP,
    CANHX_HEMO_MPAP,
    CANHX_DEV_MALFUNCTN,
    CANHX_DEV_VENT_ARRYTHM, 
    CANHX_PHYS_HR_RHYTH,
    CANHX_DEV_INFECT
    ) %>% 
  left_join(cand_thor %>% 
              dplyr::select(PX_ID, 
                     CAN_PCW_MEAN, 
                     CAN_HGT_CM, 
                     CAN_WGT_KG, 
                     CAN_CARDIAC_OUTPUT, 
                     CAN_CARDIAC_OUTPUT_MEDS
                     ))
#adding back select cand_thor hemodynamics
#durable LVAD list for elective 1A time
#lvad_list <- c(205, 206, 208, 210, 216, 217, 223, 224, 230, 231, 232, 233)
durable_list <- c(205, 206, 208, 210, 216, 217, 223, 224, 230, 231, 232, 233, 
                  305, 306, 313, 316, 319, 325, 402)
#non dischargable VADs
non_discharge <- c(201, 203, 204, 209, 215, 218, 221, 222, 225, 226, 227, 228, 
                   234, 301, 302, 303, 309, 310, 311, 320, 321)

just_1a <- just_1a %>% 
  mutate(status = "Status 1A",
         stat_just = case_when(
            CANHX_ADULT_CRITERIA_A ==1~ "Status 1A (MCS for shock)",
            CANHX_ADULT_CRITERIA_B == 1 ~ "Status 1A (MCS complication)",
            CANHX_ADULT_CRITERIA_C == 1 ~ "Status 1A (Mechanical ventilation)",
            CANHX_ADULT_CRITERIA_D == 1 ~ "Status 1A (High dose inotropes)",
            CANHX_ADULT_CRITERIA_E == 1 ~ "Status 1A (Exception)"),
    ino_ci = as.numeric(CANHX_HEMO_CI),
    ino_pcwp = as.numeric(CANHX_HEMO_PCWP),
    n_inos = ifelse(is.na(CANHX_INTRP_DOPA)==FALSE, 1, 0) + 
      ifelse(is.na(CANHX_INTRP_DOBU)==FALSE, 1, 0) + 
      ifelse(is.na(CANHX_INTRP_MILRIN)==FALSE, 1, 0),
    n_inos = ifelse(status != 2010, NA, n_inos),
    multi_ino = ifelse(n_inos > 1, 1, 0),
    single_ino = ifelse(n_inos ==1, 1, 0),
    low_d_ino = ifelse(n_inos> 1 & 
               (CANHX_INTRP_DOPA<3 | CANHX_INTRP_MILRIN <0.25 | CANHX_INTRP_DOBU < 3), 1, 0),
    low_s_ino = ifelse(n_inos ==1 & (CANHX_INTRP_MILRIN <0.5 | CANHX_INTRP_DOBU < 7.5),1,0),
    bsa = 0.007184*(CAN_HGT_CM)^(0.725)*CAN_WGT_KG^(0.425),
    tcr_ci = CAN_CARDIAC_OUTPUT/bsa,
    iabp_no_shock = case_when(
      tcr_ci > 1.8 & CAN_CARDIAC_OUTPUT_MEDS == "N" & (CANHX_IABP==1) ~ 1,
      tcr_ci > 2.0 & (CANHX_IABP==1) ~ 1,
      CAN_PCW_MEAN < 15 & CANHX_IABP ==1 ~ 1,
      is.na(tcr_ci) == FALSE & (CANHX_IABP==1) ~ 0),
    dopa_dose = CANHX_INTRP_DOPA,
    dobu_dose = CANHX_INTRP_DOBU,
    milrin_dose = CANHX_INTRP_MILRIN,
    overtreat = case_when(
      ##Note absence of SBP requirement- patients were on inotropes
        iabp_no_shock == 1 ~ 1,
        CANHX_HEMO_PCWP < 15 & CANHX_ADULT_CRITERIA_D ==1 ~ 1,
        ino_ci>2.2~ 1,
        ino_pcwp <15 ~ 1,
        (ino_ci>1.8 & CANHX_HEMO_INTRP_OBTAINED =="N") ~ 1,
        low_d_ino == 1 | low_s_ino == 1 ~ 1, 
        ino_ci <= 1.8 ~ 0,
        (ino_ci <= 2.2 & CANHX_HEMO_INTRP_OBTAINED =="Y") ~ 0,
        TRUE ~ 0),
    elective_1A = case_when(
      CANHX_ADULT_CRITERIA_A ==1 & CANHX_IABP ==0 & CANHX_ECMO ==0 & CANHX_LVAD_TYPE %in% durable_list ~1,
      TRUE ~ 0),
    Justification = case_when(
      CANHX_ADULT_CRITERIA_E ==1  ~ "Status 3- Exception",
      CANHX_ADULT_CRITERIA_C == 1 ~ "Status 3- Vent",
      CANHX_DEV_VENT_ARRYTHM == 1 & CANHX_ADULT_CRITERIA_B ==1 ~ "Status 1-MSCD with Life Threatening Arrhythmia",
    CANHX_ECMO == 1 ~ "Status 1-VA ECMO",
    CANHX_ADULT_CRITERIA_A ==1 & CANHX_VAD == 1 & is.na(CANHX_RVAD_TYPE)== FALSE & (CANHX_LVAD_TYPE %in% non_discharge)~ "Status 1-Non-Dischargeable BiVAD",
    CANHX_VAD == 1 & CANHX_LVAD_TYPE %in% non_discharge ~ "Status 2-Non-Dischargeable LVAD",
    CANHX_DEV_MALFUNCTN == 1 ~ "Status 2-MSCD Device with Malfunction",
    CANHX_ADULT_CRITERIA_A ==1 & CANHX_IABP ==0 & elective_1A==0  ~ "Status 2-Other MSCD",
    CANHX_IABP ==1 & overtreat == 0 ~ "Status 2-Intra Aortic Balloon Pump",
    CANHX_PHYS_HR_RHYTH == 7 ~ "Status 2-Ventricular Tachycardia (VT)",
    CANHX_PHYS_HR_RHYTH == 8 ~ "Status 2-Ventricular Fibrillation (VF)",
    CANHX_ADULT_CRITERIA_B == 1 ~ "Status 3-MSCD Complication",
    elective_1A == 1 ~ "Status 3-Dischargeable LVAD on elective time",
    overtreat == 0 ~ "Status 3-Multiple inotropes or a single high dose inotrope and hemodynamic monitoring",
    overtreat == 1 & CANHX_IABP == 1~ "Status 3-IABP Downgraded Due to Cardiogenic Shock Requirement",
    overtreat == 1 & CANHX_ECMO == 1~ "Status 3- Downgraded Due to Cardiogenic Shock Requirement",
    overtreat == 1 ~ "Status 4-Inotropes Downgraded Due to Cardiogenic Shock Requirement"
))


just_1a <- just_1a %>%
  mutate(six_status = case_when(
    grepl("Status 1", Justification) ~ "Status 1",
    grepl("Status 2", Justification) ~ "Status 2",
    grepl("Status 3", Justification) ~ "Status 3",
    grepl("Status 4", Justification) ~ "Status 4"
    ))

just_1a <- just_1a %>%
  mutate(treatment = case_when(
    stat_just == "Status 1A (Exception)" | stat_just == "Status 1A (Mechanical ventilation)" ~ "Exception",
    Justification %in% c("Status 1-MSCD with Life Threatening Arrhythmia",
                         "Status 2-MSCD Device with Malfunction",
                         "Status 3-Dischargeable LVAD on elective time",
                         "Status 3-MSCD Complication") ~ "LVAD",
    Justification %in% c("Status 1-Non-Dischargeable BiVAD",
                         "Status 2-Non-Dischargeable LVAD",
                         "Status 2-Other MSCD")~"Other MCS",
    Justification == "Status 1-VA ECMO"~"ECMO",
    Justification %in% c("Status 2-Intra Aortic Balloon Pump",
                         "Status 3-IABP Downgraded Due to Cardiogenic Shock Requirement")~"IABP",
    Justification %in% c("Status 2-Ventricular Tachycardia (VT)",
                         "Status 2-Ventricular Fibrillation (VF)")~ "Exception",
    Justification == "Status 3-Multiple inotropes or a single high dose inotrope and hemodynamic monitoring"~"High-dose Inotropes",
    Justification == "Status 3- Exception" ~ "Exception",
    Justification == "Status 4-Inotropes Downgraded Due to Cardiogenic Shock Requirement"~"High-dose Inotropes")) %>%
  dplyr::select(PX_ID, 
         status, 
         CANHX_CHG_DT, 
         six_status, 
         Justification, 
         treatment, 
         CANHX_HEMO_SBP, 
         CANHX_HEMO_CI, 
         CANHX_HEMO_PCWP, 
         CANHX_HEMO_INTRP_OBTAINED) %>%
  group_by(PX_ID) %>% 
  arrange(PX_ID, CANHX_CHG_DT) %>%
  filter(row_number() ==1)
just_1a %>% group_by(treatment) %>% count(Justification)

```

## Status 1B -> Status 4
```{r stat_1b}
status_1b <- init_list %>% 
  filter(list_date < policy_switch_date & CAN_INIT_STAT == 2020)

just_1b <- statjust_hr1b %>% 
  filter(PX_ID %in% status_1b$PX_ID) %>%
  left_join(cand_thor %>% dplyr::select(PX_ID, CAN_DGN, CAN_PCW_MEAN, CAN_HGT_CM, CAN_WGT_KG, CAN_CARDIAC_OUTPUT))  #adding back select cand_thor hemodynamics and diagnosis codes
#remove redundant or erroneous justifications
just_1b <- distinct(just_1b) %>%
  filter(CANHX_FORM_STAT == 4 | CANHX_FORM_STAT == 8) %>%
  distinct(PX_ID, CANHX_CHG_DT, .keep_all = TRUE)
#restrictive, amyloid, CHD, and HCOM, cardiomyopathy diagnoses to upgrade old Status 2 candidates
stat4_diagnoses <- c(1050, 1051, 1052, 1053, 1054, 1099, 1100, 1101, 1102, 
                     1103, 1104, 1105, 1106, 1199, 1200, 1201, 1203, 1205, 1206, 1207, 1208)
#simple recode for Status 1B...
just_1b <- just_1b %>%
  mutate(
    bsa = 0.007184*(CAN_HGT_CM)^(0.725)*CAN_WGT_KG^(0.425),
    tcr_ci = CAN_CARDIAC_OUTPUT/bsa,
    Justification = case_when(
      CANHX_VAD == 1 ~"Status 4-Dischargeable LVAD without discretionary 30 days",
      tcr_ci >= 2.2 & CANHX_CONT_IV_INOTROP == 1 ~ "Status 6-Low dose inotropes but cardiac index too high",
      CAN_PCW_MEAN <= 15 & CANHX_CONT_IV_INOTROP == 1~ "Status 6-Low dose inotropes but wedge too low",
      CANHX_CONT_IV_INOTROP == 1 ~ "Status 4-Inotropes without Hemodynamic Monitoring",
      CAN_DGN %in% stat4_diagnoses ~ "Status 4-Medical diagnoses that qualify for status 4",
    TRUE ~ "Status 4-Exception"))

just_1b <- just_1b %>%
 mutate(status = "Status 1B",
        treatment = case_when(
   Justification %in% c("Status 4-Inotropes without Hemodynamic Monitoring", "Status 6-Low dose inotropes but cardiac index too high", "Status 6-Low dose inotropes but wedge too low") ~"Low-dose Inotropes",
   Justification == "Status 4-Dischargeable LVAD without discretionary 30 days"~"LVAD",
   Justification == "Status 4-Medical diagnoses that qualify for status 4" ~ "None",
   Justification ==  "Status 4-Exception" ~ "Exception")) %>%
  select(PX_ID, status, CANHX_CHG_DT, Justification, treatment, tcr_ci) %>%
  group_by(PX_ID) %>% 
  arrange(PX_ID, CANHX_CHG_DT) %>%
  filter(row_number() ==1)

just_1b <- just_1b %>%
  mutate(six_status = case_when(
    grepl("Status 6", Justification) ~ "Status 6",
    grepl("Status 4", Justification) ~ "Status 4"
    ))
just_1b %>% group_by(treatment) %>% count(Justification)
just_1b %>% 
  group_by(Justification) %>%
  summarise(min_CI = min(tcr_ci, na.rm = TRUE))
```


## Combine status 1A and 1B justification data with initial listings from `cand_thor`, code old Status 2 -> Status 5/6
```{r combine_data_sets}
#restrictive, amyloid, CHD, and HCOM, cardiomyopathy diagnoses to upgrade old Status 2 candidates
stat4_diagnoses <- c(1050, 1051, 1052, 1053, 1054, 1099, 1100, 1101, 1102, 
                     1103, 1104, 1105, 1106, 1199, 1200, 1201, 1203, 1205, 1206, 1207, 1208)

just_1a_1b <- bind_rows(just_1a, just_1b)

multi_recips <- tx_hr %>% 
  filter(REC_TX_TY == 2 | REC_TX_TY ==4) %>% select(PX_ID,REC_TX_DT)

old_policy_lists <- init_list %>%
  filter(list_date < policy_switch_date & CAN_INIT_STAT< 2100) %>%
  select(PX_ID, 
         list_date, 
         CAN_DGN, 
         CAN_INIT_STAT, 
         CAN_PCW_MEAN, 
         CAN_CARDIAC_OUTPUT, 
         CAN_WGT_KG, 
         center,
         CAN_HGT_CM) %>%
  left_join(just_1a_1b, by = c("PX_ID")) %>%
  mutate(Justification = case_when(
    CAN_INIT_STAT ==2030 & CAN_DGN %in% stat4_diagnoses ~ "Status 4-Medical diagnoses that qualify for status 4",
    CAN_INIT_STAT ==2030 ~ "Status 6-Adult Candidates Suitable for Transplant",
    TRUE ~ Justification
  ),
  treatment = ifelse(CAN_INIT_STAT ==2030, "None", treatment),
  six_status = case_when(
    CAN_INIT_STAT ==2030 & CAN_DGN %in% stat4_diagnoses ~"Status 4",
    CAN_INIT_STAT ==2030 & PX_ID %in% multi_recips$PX_ID ~ "Status 5",
    CAN_INIT_STAT ==2030 ~ "Status 6",
    TRUE ~ six_status
  )) %>% 
  select(PX_ID, status = six_status, list_date, treatment, CAN_INIT_STAT, CAN_PCW_MEAN, CAN_CARDIAC_OUTPUT, CAN_WGT_KG, CAN_HGT_CM, CANHX_HEMO_SBP, CANHX_HEMO_CI, CANHX_HEMO_PCWP, CANHX_HEMO_INTRP_OBTAINED,center)
  
old_policy_lists %>% group_by(status) %>% count(treatment)
skimr::skim(old_policy_lists)
```

# Clean post-policy listings

Finding initial justification forms from the special files and linking to `cand_thor` so we isolate new listings from after the policy implementation

```{r use_cand_thor_to_identify_new_lists}
new_post_policy_lists <- init_list %>%
  filter(list_date >= policy_switch_date & CAN_INIT_STAT> 2100) %>%
  mutate(status = CAN_INIT_STAT,
         PX_ID = as.integer(PX_ID)) %>%
  select(PX_ID, 
         list_date, 
         status, 
         CAN_INIT_STAT, 
         CAN_PCW_MEAN, 
         CAN_CARDIAC_OUTPUT, 
         CAN_WGT_KG, 
         CAN_HGT_CM,
         center)

status_ep_with_PX_ID <- StatusJustEpisode %>%
  left_join(JustFormHRDataLink %>% select(WlregAuditId, JustId), by = "JustId") %>%
  left_join(WlregAuditId_PxId, by = "WlregAuditId") %>%
  mutate(PX_ID = px_id) %>%
  select(-px_id) %>%
  filter(PX_ID %in% new_post_policy_lists$PX_ID) %>%
  left_join(JustFormHR %>% select(JustId, status = RequestedCandStatCd, Exception)) %>%
  select(PX_ID, BeginDate, status, Exception, JustId) %>%
  mutate(list_date = as.Date(BeginDate))
  
new_post_policy_lists <- new_post_policy_lists %>% 
  left_join(status_ep_with_PX_ID, by = c("PX_ID", "list_date", "status")) %>%
  group_by(PX_ID) %>%
  arrange(BeginDate) %>%
  filter(row_number() ==1) %>% #taking the first justification form (JustId) filed on that day for now
  ungroup()


```

```{r status_count_new}
new_post_policy_lists %>% count(status)
```

## Status 1 form cleaning
```{r status_1}

post_policy_justs <- new_post_policy_lists$JustId

# select only justifications that appear in first_ep
#coding life-threatening arrythmia as an "exception"

status_1 <- statjust_hr1 %>%
  filter(JustId %in% post_policy_justs) %>%  
  left_join(new_post_policy_lists %>% 
              select(PX_ID, JustId, Exception, status,list_date, center)) %>%
  mutate(
    treatment = case_when(
      CriteriaEcmoSupport == TRUE ~ "ECMO",
      CriteriaBivadSupport == TRUE ~ "Other MCS",
      CriteriaMcsdSupport == TRUE | Exception == TRUE ~ "Exception" 
    )
  ) %>% select(PX_ID, JustId, treatment, status, EcmoCardiacIndex, CardiacIndexInotropeSupport, EcmoCapWedgePressure, EcmoWithoutHemo,list_date, center)

status_1 %>% count(treatment)
status_1
```

## Status 2 form cleaning

```{r status_2}

#only true durable dischargable LVAD crtieria for Status 2 is malfunction
#labelling VT/VF as an exception
status_2 <- statjust_hr2 %>%
  filter(JustId %in% post_policy_justs) %>%
  left_join(new_post_policy_lists %>% select(PX_ID,JustId, Exception, status,list_date, center)) %>%
  mutate(
    treatment = case_when(
      CriteriaIabpSupport == TRUE ~ "IABP",
      CriteriaMcsdMalfunction == TRUE ~ "LVAD", 
      CriteriaDurableDevSupport == TRUE |  CriteriaMcsdEndovasSupp == TRUE | CriteriaLvadSupport == TRUE ~ "Other MCS",
      CriteriaVentEpisode == TRUE ~ "Exception", 
      Exception == TRUE ~ "Exception"
    )
  ) %>% select(PX_ID,JustId, treatment, status, IabpCardiacIndex, IabpCapWedgePressure, IabpWithHemo, IabpWithoutHemo, IabpCardiacIndexInotropeSup,list_date, center)


status_2 %>% count(treatment)
status_2
```

## Status 3 form cleaning

### Variables needed for the hemodynamic graphs from high dose inotrope candidates selected

```{r status_3}
status_3 <- statjust_hr3 %>%
  filter(JustId %in% post_policy_justs) %>%
  left_join(new_post_policy_lists %>% select(PX_ID,JustId, Exception, status,list_date, center)) %>%
  mutate(
    treatment = case_when(
      CriteriaPercuSupport == TRUE ~ "Other MCS",
      CriteriaLvadDiscSupport == TRUE | CriteriaMcsdWithHemo == TRUE | CriteriaMcsdWithPump == TRUE | CriteriaMcsdWithRhf == TRUE ~ "LVAD",
      CriteriaMcsdInfection == TRUE | CriteriaMcsdMucosalBleed == TRUE |  CriteriaMcsdWithAI == TRUE | CriteriaLvadSupport == TRUE ~ "LVAD",
      CriteriaInotropeSupport == TRUE ~ "High-dose Inotropes",
      CriteriaVaEcmoSupport == TRUE ~ "ECMO",
      CriteriaIabpSupport == TRUE ~ "IABP",
      Exception == TRUE ~ "Exception"
    )
  ) %>% select(PX_ID,JustId, treatment, status, InoSysBloodPressure, InoCardiacIndex, InoCapWedgePressure, InoInotropeSupport,list_date, center)
status_3 %>% count(treatment)
```

## Status 4 form cleaning

```{r status_4}
status_4 <- statjust_hr4 %>%
  filter(JustId %in% post_policy_justs) %>%
  left_join(new_post_policy_lists %>% select(PX_ID,JustId, Exception, status,list_date, center)) %>%
  mutate(
    treatment = case_when(
      CriteriaLvadSupport == TRUE ~ "LVAD",
      CriteriaInotropeSupport == TRUE ~ "Low-dose Inotropes",
      CriteriaHeartDisease == TRUE | CriteriaIschemicHeart == TRUE | CriteriaCardiomyopathy == TRUE | CriteriaRetransplant == TRUE ~ "None",
      Exception == TRUE ~ "Exception"
    )
  ) %>% select(PX_ID,JustId, treatment, status, InotropeCardiacIndex, InotropePcwp,list_date, center)
status_4 %>% count(treatment)
```

## Status 5-6 coding
```{r status_5_6}
status_5_6 <- new_post_policy_lists %>%
  filter(status %in% c(2150, 2160, 1150, 1160)) %>%
  mutate(treatment = "None" ) %>%
  select(PX_ID,JustId, treatment, status,center,list_date)
```

## Combine and create full post dataset
```{r post-dataset, warning = FALSE, message= FALSE}
init_list <- init_list %>% 
    mutate(PX_ID = ifelse(is.na(PX_ID)==FALSE,as.integer(PX_ID),PX_ID))


post_justifications <- bind_rows(status_1, status_2, status_3, status_4, status_5_6) %>%
  mutate(status = case_when(
           status %in% c(1110, 2110) ~ "Status 1",
           status %in% c(1120, 2120) ~ "Status 2",
           status %in% c(1130, 2130) ~ "Status 3",
           status %in% c(1140, 2140) ~ "Status 4",
           status %in% c(1150, 2150) ~ "Status 5",
           status %in% c(1160, 2160) ~ "Status 6"
         )) %>%
  left_join(init_list %>% dplyr::select(PX_ID, list_date, CAN_INIT_STAT, CAN_PCW_MEAN, CAN_CARDIAC_OUTPUT, CAN_WGT_KG, CAN_HGT_CM,center))

post_justifications %>% group_by(status) %>% count(treatment)
```

# Final Sample - Without Transplant Center Characteristics

This dataframe contains all listings matched with their variables used for the analysis.

```{r create_final_sample}

#put together pre and post policy information contained in old_policy_lists and post_justifications respectively
final_sample <- bind_rows(old_policy_lists, 
                          post_justifications %>% select(PX_ID, 
                                                         status, 
                                                         list_date,
                                                         treatment,
                                                         center,
                                                         CAN_INIT_STAT, 
                                                         CAN_PCW_MEAN, 
                                                         CAN_CARDIAC_OUTPUT, 
                                                         CAN_WGT_KG, 
                                                         CAN_HGT_CM,
                                                         EcmoCardiacIndex,
                                                         CardiacIndexInotropeSupport,
                                                         EcmoCapWedgePressure,
                                                         IabpCardiacIndexInotropeSup,
                                                         IabpCardiacIndex,
                                                         IabpCapWedgePressure,
                                                         InoSysBloodPressure, 
                                                         InoCardiacIndex, 
                                                         InoCapWedgePressure,
                                                         InoInotropeSupport, 
                                                         InotropePcwp,
                                                         InotropeCardiacIndex)) %>%
    mutate(policy = case_when(
                  list_date <= pre_policy_end_date ~ paste0(format(start_date, "%b %Y"), " - ", format(pre_policy_end_date, "%b %Y"), " (Pre-Policy)"),
                  list_date >= post_policy_start_date ~  paste0(format(post_policy_start_date, "%b %Y"), " - ", format(end_date, "%b %Y"), " (Post-policy)")
             )) %>% 
  left_join(cand_thor %>% select(PX_ID, CAN_CARDIAC_OUTPUT_MEDS, CAN_PCW_MEAN_MEDS)) %>% 
  mutate(bsa = 0.007184*(CAN_HGT_CM)^(0.725)*CAN_WGT_KG^(0.425),
         sbp = case_when(
           is.na(CANHX_HEMO_SBP) == FALSE ~ CANHX_HEMO_SBP,
           is.na(InoSysBloodPressure) == FALSE ~ InoSysBloodPressure
         ),
         CI_list = CAN_CARDIAC_OUTPUT/bsa,
         CI_list = ifelse(CI_list> 10, NA, CI_list),
         CI_just = case_when(
           is.na(CANHX_HEMO_CI) == FALSE ~ CANHX_HEMO_CI,
           is.na(InoCardiacIndex) == FALSE ~ InoCardiacIndex,
           is.na(IabpCardiacIndex) == FALSE ~ IabpCardiacIndex,
           is.na(InotropeCardiacIndex) == FALSE ~ InotropeCardiacIndex,
           is.na(EcmoCardiacIndex) == FALSE ~ EcmoCardiacIndex
         ),
         PCWP_list = CAN_PCW_MEAN,
         PCWP_just = case_when(
           is.na(CANHX_HEMO_PCWP) == FALSE ~ CANHX_HEMO_PCWP,
           is.na(InoCapWedgePressure) == FALSE ~ InoCapWedgePressure,
           is.na(EcmoCapWedgePressure) == FALSE ~ EcmoCapWedgePressure,
           is.na(IabpCapWedgePressure) == FALSE ~ IabpCapWedgePressure,
           is.na(InotropePcwp) == FALSE ~ InotropePcwp
         ),
         just_measured_on_ino = case_when(
           CANHX_HEMO_INTRP_OBTAINED == "N" ~ 0,
           InoInotropeSupport == "N" ~ 0,
           IabpCardiacIndexInotropeSup == "N"~ 0,
           CardiacIndexInotropeSupport == "N" ~ 0,
           treatment == "High-dose Inotropes" & is.na(CI_just) == FALSE ~ 1,
           treatment == "IABP" & is.na(CI_just) == FALSE ~ 1,
           is.na(InotropeCardiacIndex) == FALSE ~ 1,
           is.na(EcmoCardiacIndex) == FALSE ~1))%>% 
  select(PX_ID, status, list_date, policy, treatment, CAN_INIT_STAT, sbp, CI_list, CAN_CARDIAC_OUTPUT_MEDS, CI_just, just_measured_on_ino, PCWP_list, CAN_PCW_MEAN_MEDS, PCWP_just,center)

final_sample %>% filter(list_date > as.Date("2019-01-08") & treatment == "Low-dose Inotropes")

skimr::skim(final_sample)
```

# Data quality checks

### histogram of status pre-policy statuses
```{r pre_policy_hist}
final_sample %>%
  filter(CAN_INIT_STAT < 2100) %>%
  mutate(treatment = factor(treatment, 
                            levels = c("ECMO", "Other MCS",
                                       "IABP","High-dose Inotropes",
                                       "LVAD", "Low-dose Inotropes",  
                                       "Exception", "None"))) %>%
  ggplot(aes(x = factor(CAN_INIT_STAT), fill = treatment)) +
  geom_bar(color = "grey") + 
  labs(
    x = "",
    y = "Number of Candidates") +
  scale_x_discrete(breaks=c("2010","2020","2030"),
        labels=c("Status 1A", "Status 1B", "Status 2")) +
  scale_fill_brewer(palette="Paired", direction = -1) +
  theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

Looks like the treatment codings are appropriate for the Pre-policy status.

### listings by month
```{r listings_by_month}
library(zoo)
final_sample %>% 
  mutate(month = zoo::as.yearmon(list_date)) %>%
ggplot(aes(x = as.factor(month), fill = policy, color = policy )) + 
  geom_bar() + 
  labs(x = "month", y = "number of initial adult listings") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

finalsample_listdate <- final_sample %>%
  filter(is.na(list_date))
```

Separation of cohorts is clear


## Counting the number of inactives
```{r inactive count}
inactivesCount <- cand_thor %>% 
  mutate(list_date = CAN_LISTING_DT) %>% 
    filter(list_date >= start_date & list_date <= end_date & WL_ORG == "HR")  %>% 
  mutate(status = CAN_INIT_STAT, 
         date_start = list_date)

#remove peds
if (peds == FALSE){
    init_list <- init_list %>% filter(CAN_AGE_AT_LISTING >17)   
    tot_adults <- nrow(init_list)
}

#keep multiorgan recipients
if (multi == FALSE){
    multi_recips <- tx_hr %>% filter(REC_TX_TY == 2 | REC_TX_TY ==4) %>% select(PX_ID,REC_TX_TY)
  
    n_mults <- nrow(init_list %>% filter(PX_ID %in% multi_recips$PX_ID))
    
    init_list <- init_list %>% filter(!PX_ID %in% multi_recips$PX_ID)
    remove(multi_recips)
}

inactivesCountPre <- inactivesCount %>%
  dplyr::select(list_date, CAN_INIT_STAT) %>%
  filter(list_date >= "2016-12-1") %>%
  filter(list_date < "2018-02-28") %>%
  count(CAN_INIT_STAT)

inactivesCountPost <- inactivesCount %>%
  dplyr::select(list_date, CAN_INIT_STAT) %>%
  filter(list_date >= "2018-12-01") %>%
  filter(list_date < "2020-02-28") %>%
  count(CAN_INIT_STAT)

```

There are 253 inactive listing in the pre-policy cohort, and 150 in the post-policy cohort. 

# Center-Level Predictors
Information regarding the transplant center that listed each candidate needs to be pended to the main dataset of analysis. 

## Clean institution data
We will exclude any transplant lists from  foreign institutions, unknown labs or other unknown institutions

```{r clean institution data}
#remove institutions that are not in the U.S. and are missing information regarding location
institution_clean <- institution %>% 
  filter(!is.na(REGION)) %>% 
  filter(REGION<98) %>% 
  dplyr::select(CTR_CD, 
         CTR_ID,
         CTR_TY,
         OPTN_MBR,
         PRIMARY_CITY,
         PRIMARY_STATE,
         PRIMARY_ZIP,
         PROVIDER_NUM,
         REGION) %>% 
  mutate(center = CTR_ID)
#pend center data to cleaned candidate-level dataset
final_sample_with_center <- final_sample %>% 
  left_join(institution_clean,by = "center") %>% 
  dplyr::select(-CTR_ID)
```

```{r append OPO level data}
#clean opo data
opo_clean <- opo %>% 
  mutate (CTR_CD = TXC_CTR_CD) %>% 
  filter (END_DT > as.Date("2016-12-01")) %>% 
  select (- TXC_CTR_CD) %>% 
  distinct(CTR_CD, .keep_all = TRUE)

#append opo data to final_sample_with_center by center_code

final_sample_geo <- final_sample_with_center %>% 
  left_join(opo_clean, by = "CTR_CD")

#there are 52 OPO represented in this sample
opo_list <- final_sample_geo %>% 
  select(SERVED_OPO_CD) %>% 
  unique() 
```

```{r center listing volume}
#find center listing volume
final_geo <- final_sample_geo %>% 
  add_count(as.factor(CTR_CD), name = "CTR_Volume") %>%
  select (-CTR_CD,-START_DT,-END_DT) %>% 
  rename(CTR_CD = as.character("as.factor(CTR_CD)"))

#find centers that have a yearly listing volume < 5 in any of the following full years: 2017, 2018 or 2019

final_geo1 <- final_geo %>% 
  mutate(year = as.numeric(format(list_date,'%Y'))) %>%
  group_by(CTR_CD,year) %>% 
  add_count(CTR_CD,name ="CTR_YR_Volume") %>%
  ungroup()

#find the list of center names that have yearly listing volume lower than 5 in 2017, 2018 or 2019

low_volume_list <- final_geo1 %>% 
  dplyr::select(year, CTR_CD, SERVED_OPO_CD, CTR_YR_Volume) %>% 
  unique() %>% 
  filter(year == 2017 | year == 2018 | year == 2019) %>% 
  filter(CTR_YR_Volume <10) %>% 
  distinct(CTR_CD)

low_volume_list1 <- final_geo1 %>% 
  dplyr::select(policy, CTR_CD) %>% 
  group_by(policy) %>% 
  add_count(as.factor(CTR_CD), name = "CTR_Volume_per_period") %>% 
  ungroup() %>% 
  distinct() %>% 
  filter(!is.na(policy)) %>% 
  filter(CTR_Volume_per_period <10) %>% 
 dplyr:: select(-`as.factor(CTR_CD)`)
  
  
  

final_geo2<- final_geo1 %>% 
  mutate(low_volume = case_when(
    CTR_CD %in% low_volume_list$CTR_CD ~ "T",
    CTR_CD %in% low_volume_list1$CTR_CD ~ "T")) %>% 
  mutate(low_volume = replace_na(low_volume,"F"))

#count the number of low-volume centers, there are 37 low-volume centers and out of 133

low_volume_count <- final_geo2 %>%
  select(CTR_CD,low_volume,year) %>% 
  group_by(low_volume) %>%
  mutate(low_count = n_distinct(CTR_CD)) %>% 
  select(low_volume,low_count) %>% 
  unique()

#exclude low_volume_count centers
final_geo3 <- final_geo2 %>% 
  filter(low_volume == "F")
```

```{r center transplant information}
#code the transplant outcome of each candidate

transplant <- tx_hr %>% 
  select(PX_ID, REC_TX_DT)

final_geo_tx <- final_geo3 %>% 
  mutate(transplanted = ifelse(PX_ID %in% transplant$PX_ID,"Transplanted","Not")) %>% 
  left_join(transplant, by = "PX_ID") 

#find transplant volume of each center and add it back to main dataset

ctr_tx_vol <- final_geo_tx %>% 
  select(CTR_CD,transplanted, policy) %>% 
  group_by(CTR_CD,policy) %>% 
  summarise(CTR_TX_Volume = sum(transplanted == "Transplanted")) %>% 
  ungroup()

#final_geo_tx1 includes total transplant volume within observation period
final_geo_tx1 <- final_geo_tx %>% 
  left_join(ctr_tx_vol,by=c("CTR_CD", "policy")) %>% 
  select(PX_ID, status, policy, treatment, CTR_CD,SERVED_OPO_CD,CTR_Volume, CTR_TX_Volume, transplanted, list_date, REC_TX_DT,REGION)

# center 30-day and 90-day transplant rates
# final_geo_tx2 codes each candidate as having had transplant within 30 or 90 days or not

final_geo_tx2 <- final_geo_tx1 %>%
  mutate(TX_DT_30 = as.Date(list_date)+30,
         TX_DT_90 = as.Date(list_date) + 90) %>%
  mutate(TX_IN_30 = case_when(
    transplanted == "Not" ~ "No",
    transplanted == "Transplanted" & !is.na(REC_TX_DT) & REC_TX_DT> TX_DT_30 ~ "No",
    transplanted == "Transplanted" & !is.na(REC_TX_DT) & REC_TX_DT <= TX_DT_30 ~ "Yes"),
    TX_IN_90 = case_when(
      transplanted=="Not" ~ "No",
      transplanted == "Transplanted" & !is.na(REC_TX_DT) & REC_TX_DT > TX_DT_90 ~ "No",
      transplanted == "Transplanted" & !is.na(REC_TX_DT) & REC_TX_DT <= TX_DT_90 ~ "Yes"))

#count the total number of within-30-day and within-90-day transplants at each center

tx_volume <- final_geo_tx2 %>% 
  select(CTR_CD,policy, CTR_TX_Volume,transplanted,TX_IN_30,TX_IN_90)%>% 
  filter(transplanted == "Transplanted") %>%
  group_by(CTR_CD,policy) %>% 
  summarise(TX_CT_30 =  sum(TX_IN_30=="Yes"),
            TX_CT_90 = sum(TX_IN_90=="Yes")) %>% 
  ungroup() %>% 
  left_join(ctr_tx_vol, by=c("CTR_CD","policy")) %>% 
  mutate(TX_RATE_30 = TX_CT_30/CTR_TX_Volume,
         TX_RATE_90 = TX_CT_90/CTR_TX_Volume) 

#final_geo_tx3 includes 30-day and 90-day transplant count and proportion
final_geo_tx3 <- final_geo_tx1 %>% 
  left_join(tx_volume, by = c( "CTR_CD", "policy")) %>% 
  rename(CTR_TX_Volume = CTR_TX_Volume.x) %>% 
  select(-CTR_TX_Volume.y)

```


```{r center proportion of opo listing and transplant}
#find total number of listings in each OPO within observation period
opo_vol <- final_geo_tx3 %>% 
  select(SERVED_OPO_CD) %>% 
  count(SERVED_OPO_CD,name = "OPO_Volume")

#find total number of transplants done in each OPO within observation period
opo_tx_vol <- final_geo_tx3 %>% 
  select(SERVED_OPO_CD,transplanted, policy) %>% 
  group_by(SERVED_OPO_CD, policy) %>% 
  summarise(OPO_TX_Volume = sum(transplanted == "Transplanted")) %>% 
  ungroup()

#CTR_TX_Prop = # of transplants by a center/# of transplants in that OPO
final_geo_tx4 <- final_geo_tx3 %>% 
  left_join(opo_tx_vol, by = c("SERVED_OPO_CD", "policy")) %>% 
  mutate(ctr_tx_prop = CTR_TX_Volume/OPO_TX_Volume) %>% 
  left_join(opo_vol, by ="SERVED_OPO_CD") %>% 
  mutate(ctr_list_prop = CTR_Volume/OPO_Volume)

##testing that the proportions make sense
test <- final_geo_tx4 %>% 
  select(SERVED_OPO_CD,
         CTR_CD,
         CTR_Volume, 
         OPO_Volume, 
         ctr_list_prop,
         CTR_TX_Volume, 
         OPO_TX_Volume,
         ctr_tx_prop) %>%
  filter(CTR_Volume>OPO_Volume | 
           ctr_list_prop >1 |
           CTR_TX_Volume > OPO_TX_Volume |
           ctr_tx_prop>1)

remove(test)

#OPO and center Status 1 listing proportion
opo_status1 <- final_geo_tx4 %>% 
  select(status,SERVED_OPO_CD, policy) %>% 
  group_by(SERVED_OPO_CD, policy) %>% 
  summarise(
    OPO_S1 = sum(status == "Status 1")
  ) %>% 
  ungroup()

ctr_status1 <- final_geo_tx4 %>% 
  select(status,CTR_CD, policy) %>% 
  group_by(CTR_CD, policy) %>% 
  summarise(
    CTR_S1 = sum(status == "Status 1")
  ) %>% 
  ungroup()


#OPO and center Status 1 transplant number and proportions
opo_status1_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,SERVED_OPO_CD, policy) %>% 
  group_by(SERVED_OPO_CD,transplanted,policy) %>% 
  summarise(
    OPO_S1_tx = sum(status == "Status 1")
  ) %>% 
  ungroup() %>% 
  filter(transplanted== "Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(opo_tx_vol, by = c("SERVED_OPO_CD", "policy")) %>% 
  mutate(
    OPO_S1_TX_Prop = OPO_S1_tx/OPO_TX_Volume
  )

ctr_status1_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,CTR_CD,policy) %>% 
  group_by(CTR_CD,transplanted,policy) %>% 
  summarise(
    CTR_S1_tx = sum(status == "Status 1")
  ) %>% 
  ungroup() %>% 
  filter(transplanted =="Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(ctr_tx_vol,by=c("CTR_CD", "policy")) %>% 
  mutate(
    CTR_S1_TX_Prop = CTR_S1_tx/CTR_TX_Volume
  )

#OPO and center Status 2 transplant proportion

opo_status2_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,SERVED_OPO_CD,policy) %>% 
  group_by(SERVED_OPO_CD,transplanted,policy) %>% 
  summarise(
    OPO_S2_tx = sum(status == "Status 2")
  ) %>% 
  ungroup() %>% 
  filter(transplanted== "Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(opo_tx_vol, by = c("SERVED_OPO_CD", "policy")) %>% 
  mutate(
    OPO_S2_TX_Prop = OPO_S2_tx/OPO_TX_Volume
  )

ctr_status2_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,CTR_CD,policy) %>% 
  group_by(CTR_CD,transplanted,policy) %>% 
  summarise(
    CTR_S2_tx = sum(status == "Status 2")
  ) %>% 
  ungroup() %>% 
  filter(transplanted =="Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(ctr_tx_vol,by=c("CTR_CD", "policy"))%>% 
  mutate(
    CTR_S2_TX_Prop = CTR_S2_tx/CTR_TX_Volume
  )

#OPO and center Status 3 transplant proportion

opo_status3_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,SERVED_OPO_CD, policy) %>% 
  group_by(SERVED_OPO_CD,transplanted, policy) %>% 
  summarise(
    OPO_S3_tx = sum(status == "Status 3")
  ) %>% 
  ungroup() %>% 
  filter(transplanted== "Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(opo_tx_vol, by = c("SERVED_OPO_CD","policy") ) %>% 
  mutate(
    OPO_S3_TX_Prop = OPO_S3_tx/OPO_TX_Volume
  )

ctr_status3_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,CTR_CD, policy) %>% 
  group_by(CTR_CD,transplanted, policy) %>% 
  summarise(
    CTR_S3_tx = sum(status == "Status 3")
  ) %>% 
  ungroup() %>% 
  filter(transplanted =="Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(ctr_tx_vol,by=c("CTR_CD","policy")) %>% 
  mutate(
    CTR_S3_TX_Prop = CTR_S3_tx/CTR_TX_Volume
  )

#OPO and center Status 4 transplant proportion

opo_status4_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,SERVED_OPO_CD, policy) %>% 
  group_by(SERVED_OPO_CD,transplanted, policy) %>% 
  summarise(
    OPO_S4_tx = sum(status == "Status 4")
  ) %>% 
  ungroup() %>% 
  filter(transplanted== "Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(opo_tx_vol, by =c( "SERVED_OPO_CD", "policy")) %>% 
  mutate(
    OPO_S4_TX_Prop = OPO_S4_tx/OPO_TX_Volume
  )

ctr_status4_tx_vol <- final_geo_tx4 %>% 
  select(status,transplanted,CTR_CD, policy) %>% 
  group_by(CTR_CD,transplanted, policy) %>% 
  summarise(
    CTR_S4_tx = sum(status == "Status 4")
  ) %>% 
  ungroup() %>% 
  filter(transplanted =="Transplanted") %>% 
  select(-transplanted) %>% 
  left_join(ctr_tx_vol,by=c("CTR_CD","policy")) %>% 
  mutate(
    CTR_S4_TX_Prop = CTR_S4_tx/CTR_TX_Volume
  )

#testing to make sure that center-level transplant proportions by status make logical sense - the sum of transplant proportions in statuses 1-4 shouldn't add up to more than 1 for any center.

test <- ctr_status1_tx_vol %>% 
  left_join(ctr_status2_tx_vol, by="CTR_CD") %>% 
  left_join(ctr_status3_tx_vol,by = "CTR_CD") %>% 
  left_join(ctr_status4_tx_vol, by= "CTR_CD") %>% 
  mutate (
    total_prop = CTR_S1_TX_Prop + CTR_S2_TX_Prop + CTR_S3_TX_Prop + CTR_S4_TX_Prop
  ) %>% 
  filter(
    total_prop >1
  )

remove(test)

#testing to make sure that opo-level transplant proportions by status make logical sense - the sum of transplant proportions in statuses 1-4 shouldn't add up to more than 1 for any opo

test <- opo_status1_tx_vol %>% 
  left_join(opo_status2_tx_vol, by="SERVED_OPO_CD") %>% 
  left_join(opo_status3_tx_vol,by = "SERVED_OPO_CD") %>% 
  left_join(opo_status4_tx_vol, by= "SERVED_OPO_CD") %>% 
  mutate (
    total_prop = OPO_S1_TX_Prop + OPO_S2_TX_Prop + OPO_S3_TX_Prop + OPO_S4_TX_Prop
  ) %>% 
  filter(
    total_prop >1
  )

remove(test)

#merge transplant proportion in status 1-4 to main dataset

opo_tx_status_prop <- opo_status1_tx_vol %>% 
  left_join(opo_status2_tx_vol, by=c("SERVED_OPO_CD", "policy")) %>% 
  left_join(opo_status3_tx_vol,by=c("SERVED_OPO_CD", "policy")) %>% 
  left_join(opo_status4_tx_vol, by=c("SERVED_OPO_CD", "policy")) %>% 
  select(SERVED_OPO_CD,policy, OPO_S1_TX_Prop,OPO_S2_TX_Prop,OPO_S3_TX_Prop, OPO_S4_TX_Prop)

ctr_tx_status_prop <- ctr_status1_tx_vol %>% 
  left_join(ctr_status2_tx_vol, by=c("CTR_CD","policy")) %>% 
  left_join(ctr_status3_tx_vol, by=c("CTR_CD","policy")) %>% 
  left_join(ctr_status4_tx_vol, by=c("CTR_CD","policy")) %>%
  select(CTR_CD,policy, CTR_S1_TX_Prop, CTR_S2_TX_Prop, CTR_S3_TX_Prop, CTR_S4_TX_Prop)
  
final_geo_tx5 <- final_geo_tx4 %>% 
  left_join(opo_tx_status_prop,by=c("SERVED_OPO_CD","policy")) %>% 
  left_join(ctr_tx_status_prop,by=c("CTR_CD","policy"))


#OPO donor heart supply???

# number of centers in an opo
ctr_ct_opo <- final_geo_tx5 %>% 
  select(CTR_CD, SERVED_OPO_CD) %>%
  distinct_all() %>% 
  group_by(SERVED_OPO_CD) %>% 
  add_count(SERVED_OPO_CD, name = "CTR_CT_IN_OPO") %>% 
  select(-CTR_CD) %>% 
  distinct_all()


#final_geo_tx6 contains the number of transplant centers associated with each OPO
final_geo_tx6 <- final_geo_tx5 %>% 
  left_join(ctr_ct_opo,by="SERVED_OPO_CD")

```


```{r market share by transplant}
#using the proportion of transplant and proportion of listing by each center in each opo as a measure of market share
#final_geo_tx7 contains market share calculations, and renames a bunch of variables  for better description

final_geo_tx7 <- final_geo_tx6 %>% 
  rename(CTR_OPO_TX_Share= ctr_tx_prop,
         CTR_TX_CT_30 = TX_CT_30,
         CTR_TX_CT_90 = TX_CT_90,
         CTR_TX_RATE_30 = TX_RATE_30,
         CTR_TX_RATE_90 = TX_RATE_90,
         OPO_List_Vol = OPO_Volume,
         CTR_OPO_List_Share = ctr_list_prop,
         CTR_List_Vol = CTR_Volume)

#Find the number of OPO in each OPTN region
opo_ct_region <- final_geo_tx7 %>% 
  select(REGION, SERVED_OPO_CD) %>%
  distinct_all() %>% 
  group_by(REGION) %>% 
  add_count(REGION, name = "OPO_CT_IN_REGION") %>% 
  select(-SERVED_OPO_CD) %>% 
  distinct_all()

#Find the number of transplant centers in each OPTN region
ctr_ct_region <- final_geo_tx7 %>% 
  select(REGION, CTR_CD) %>%
  distinct_all() %>% 
  group_by(REGION) %>% 
  add_count(REGION, name = "CTR_CT_IN_REGION") %>% 
  select(-CTR_CD) %>% 
  distinct_all()


#Find the total number of transplants done in each region
region_tx_vol <- final_geo_tx7 %>% 
  select(REGION,transplanted,policy) %>% 
  group_by(REGION,policy) %>% 
  summarise(REGION_TX_Volume = sum(transplanted == "Transplanted")) %>% 
  ungroup()

#Find total number of listing in each region
region_list_vol <- final_geo_tx7 %>% 
  select(REGION,policy) %>% 
  add_count(REGION,name = "REGION_List_Volume") %>% 
  distinct_all()

#final_geo_tx8 has region listing count, tx count, number of opo in each reagion, number of transplant centers in each region and market share of each OPO in the OPTN region
REGION_data <- region_tx_vol %>% 
  left_join(ctr_ct_region, by="REGION") %>% 
  left_join(opo_ct_region, by="REGION") %>% 
  left_join(region_list_vol, by=c("REGION","policy")) %>% 
  rename(REGION_OPO_CT = OPO_CT_IN_REGION,
         REGION_CTR_CT = CTR_CT_IN_REGION)

final_geo_tx8 <- final_geo_tx7 %>% 
  left_join(REGION_data,by=c("REGION","policy")) %>% 
  mutate(
    OPO_REGION_TX_Share = OPO_TX_Volume/REGION_TX_Volume,
    CTR_REGION_TX_Share = CTR_TX_Volume/REGION_TX_Volume,
    OPO_REGION_List_Share = OPO_List_Vol/REGION_List_Volume,
    CTR_REGION_List_Share = CTR_List_Vol/REGION_List_Volume)
  

#calculate HHI for each OPO in each OPTN region

HHI_TX_OPO_REGION <- final_geo_tx8 %>% 
  select(REGION, SERVED_OPO_CD, OPO_REGION_TX_Share, policy) %>% 
  distinct() %>% 
  mutate(OPO_REGION_TX_SHARE_PERCENT = 100*OPO_REGION_TX_Share) %>% 
  group_by(REGION, policy) %>% 
  mutate(REGION_OPO_TX_HHI = sum(OPO_REGION_TX_SHARE_PERCENT^2)) %>% 
  select(REGION,REGION_OPO_TX_HHI) %>% 
  distinct() %>% 
  ungroup()


#calculate HHI for each CTR in each OPO
HHI_TX_CTR_OPO <-final_geo_tx8 %>% 
  select(SERVED_OPO_CD, CTR_CD,CTR_OPO_TX_Share, policy) %>% 
  distinct() %>% 
  mutate(CTR_OPO_TX_SHARE_PERCENT = 100*CTR_OPO_TX_Share) %>% 
  group_by(SERVED_OPO_CD, policy) %>% 
  mutate(OPO_CTR_TX_HHI = sum(CTR_OPO_TX_SHARE_PERCENT^2)) %>% 
  select(SERVED_OPO_CD,OPO_CTR_TX_HHI) %>% 
  distinct() %>% 
  ungroup

#calculate HHI for each CTR in each OPTN region
HHI_TX_CTR_REGION <- final_geo_tx8 %>% 
  select(REGION, CTR_CD,CTR_REGION_TX_Share, policy) %>% 
  distinct() %>% 
  mutate(CTR_REGION_TX_SHARE_PERCENT = 100*CTR_REGION_TX_Share) %>% 
  group_by(REGION, policy) %>% 
  mutate(REGION_CTR_TX_HHI = sum(CTR_REGION_TX_SHARE_PERCENT^2)) %>% 
  select(REGION,REGION_CTR_TX_HHI) %>% 
  distinct() %>% 
  ungroup()

#final_geo_tx9 includes HHI at region and opo level based on shares of total transplant volume
final_geo_tx9 <- final_geo_tx8 %>% 
  left_join(HHI_TX_OPO_REGION,by=c("REGION", "policy")) %>% 
  left_join(HHI_TX_CTR_OPO,by=c("SERVED_OPO_CD", "policy")) %>% 
  left_join(HHI_TX_CTR_REGION,by=c("REGION", "policy"))

```


```{r market share by listing}
#calculate HHI for each OPO in each OPTN region by listing proportion

HHI_LIST_OPO_REGION <- final_geo_tx9 %>% 
  select(REGION, SERVED_OPO_CD, OPO_REGION_List_Share, policy) %>% 
  distinct() %>% 
  mutate(OPO_REGION_LIST_SHARE_PERCENT = 100*OPO_REGION_List_Share) %>% 
  group_by(REGION, policy) %>% 
  mutate(REGION_OPO_LIST_HHI = sum(OPO_REGION_LIST_SHARE_PERCENT^2)) %>% 
  select(REGION,REGION_OPO_LIST_HHI) %>% 
  distinct()


#calculate HHI for each CTR in each OPO
HHI_LIST_CTR_OPO <-final_geo_tx9 %>% 
  select(SERVED_OPO_CD, CTR_CD,CTR_OPO_List_Share, policy) %>% 
  distinct() %>% 
  mutate(CTR_OPO_LIST_SHARE_PERCENT = 100*CTR_OPO_List_Share) %>% 
  group_by(SERVED_OPO_CD, policy) %>% 
  mutate(OPO_CTR_LIST_HHI = sum(CTR_OPO_LIST_SHARE_PERCENT^2)) %>% 
  select(SERVED_OPO_CD,OPO_CTR_LIST_HHI) %>% 
  distinct()

#calculate HHI for each CTR in each OPTN region
HHI_LIST_CTR_REGION <- final_geo_tx8 %>% 
  select(REGION, CTR_CD,CTR_REGION_List_Share, policy) %>% 
  distinct() %>% 
  mutate(CTR_REGION_LIST_SHARE_PERCENT = 100*CTR_REGION_List_Share) %>% 
  group_by(REGION, policy) %>% 
  mutate(REGION_CTR_LIST_HHI = sum(CTR_REGION_LIST_SHARE_PERCENT^2)) %>% 
  select(REGION,REGION_CTR_LIST_HHI) %>% 
  distinct()

#final_geo_tx10 has market share data based on listing
final_geo_tx10 <- final_geo_tx9 %>% 
  left_join(HHI_LIST_OPO_REGION,by=c("REGION", "policy")) %>% 
  left_join(HHI_LIST_CTR_OPO,by=c("SERVED_OPO_CD", "policy")) %>% 
  left_join(HHI_LIST_CTR_REGION,by=c("REGION", "policy"))

```

#Attach candidate level variables
```{r candidate level variable}
# age at listing
# height
# weight
# blood type
# sex
# bmi
# functional status (need to code)
# working for income
# race
# college education
# payor
# diagnosis (ischemic, restrictive, other)
# diabetes
# renal function (30-59, <30, on dialysis)
# smoking history
# history of CVA
# history of malignancy
# history of cardiac surgery
# defibrillator in place


cand_var <- final_geo_tx10 %>%
  select(policy, PX_ID) %>%
  left_join(cand_thor) %>%
  filter(PX_ID %in% final_geo_tx10$PX_ID) %>%
   mutate(age = CAN_AGE_AT_LISTING,
         female = ifelse(CAN_GENDER == "F", 1, 0),
         race = factor(CAN_RACE),
         race = fct_lump(race, n = 3),
         race = fct_recode(race,
                          "White" = "8",
                          "Black" = "16",
                          "Hispanic" = "2000", 
                          "Other" = "Other"),
         bmi = CAN_BMI,
        simple_diagnosis = case_when(
          CAN_DGN>999 & CAN_DGN<1007 ~ "Dilated cardiomyopathy, non-ischemic",
          CAN_DGN == 1007 | CAN_DGN ==1200 ~ "Ischemic cardiomyopathy",
          CAN_DGN>1048 & CAN_DGN< 1100 ~ "Restrictive cardiomyopathy",
          TRUE ~ "Other"
        ),
        "Diagnosis" = factor(simple_diagnosis, 
                           levels = c("Dilated cardiomyopathy, non-ischemic", 
                                      "Ischemic cardiomyopathy", 
                                      "Restrictive cardiomyopathy", 
                                      "Other")),
        diabetes = case_when(
          CAN_DIAB_TY>1 & CAN_DIAB_TY<6 ~ "History of DM",
          CAN_DIAB_TY ==1 ~ "Non-diabetic",
          TRUE ~ "Unknown"
        ),
        diabetes = factor(diabetes),
        female_gfr = if_else(CAN_GENDER == "F", 0.742, 1),
        black_gfr = if_else(race == "Black", 1.21, 1),
        eGFR = 175*((CAN_MOST_RECENT_CREAT)^(-1.154))*(CAN_AGE_AT_LISTING^(-0.203))*female_gfr*black_gfr,
        functional_status = case_when(
          CAN_FUNCTN_STAT == 1 | (CAN_FUNCTN_STAT>2069) ~"Limited Impairment, 100-70%",
          CAN_FUNCTN_STAT ==2 | (CAN_FUNCTN_STAT>2049 & CAN_FUNCTN_STAT<2061) ~ "Moderate Impairment, 50-60%",
          CAN_FUNCTN_STAT == 3 | (CAN_FUNCTN_STAT>2000 & CAN_FUNCTN_STAT<2041) ~ "Severe Impairment â‰¥ 40%%",
          TRUE ~ "Unknown"
        ),
        functional_status = ifelse(is.na(functional_status), "Unknown", functional_status),
        functional_status = factor(functional_status),
        pcwp = CAN_PCW_MEAN,
        body_surface_area = 0.007184*(CAN_HGT_CM)^(0.725)*CAN_WGT_KG^(0.425),
        cardiac_index = as.numeric(CAN_CARDIAC_OUTPUT/body_surface_area),
        cardiac_index = ifelse(cardiac_index>10, NA, cardiac_index),
        blood_type = factor(
           case_when(
             CAN_ABO %in% c("A", "A1", "A2") ~ "A",
             CAN_ABO %in% c("A1B", "A2B") ~ "AB",
             TRUE ~ CAN_ABO)
           ),
        payor = case_when(
          CAN_PRIMARY_PAY %in% c(3,4,13) ~ "Medicare",
          CAN_PRIMARY_PAY ==2 ~ "Medicaid",
          CAN_PRIMARY_PAY == 1 ~ "Private",
          TRUE ~ "Other"
        ),
        History_of_Smoking = case_when(
           CAN_HIST_CIGARETTE == "Y" ~ "Smoking history",
           CAN_HIST_CIGARETTE == "N" ~ "No prior smoking history"),
        Working = case_when(
           CAN_WORK_INCOME == "N" ~ "Not working",
           CAN_WORK_INCOME == "Y" ~ "Working"),
        Education_Status = case_when(
          CAN_EDUCATION %in% c(4,5,6) ~ "College",
          CAN_EDUCATION == 3 ~ "High School",
          TRUE ~ "Less than high school or other"
        ),
  ) %>%
  select(PX_ID, #patient ID and listing status
         age, female, race, #basic demographics
         History_of_Smoking, Working, Education_Status,
         bmi, blood_type, "Diagnosis", eGFR, diabetes, functional_status, #diagnosis and medical comorbidities, some factor variables some continuous
         cardiac_index, pcwp, #hemodynamics
         payor, #payor
         #ecmo, iabp, lvad, other_mcs, high_dose_inotropes, low_dose_inotropes #treatments- hot coded
         ) %>%
  mutate_if(is.character, factor) %>% 
  mutate(bmi = substr(bmi, 0, 2)) %>% 
  mutate(bmi = as.numeric(bmi))

#there 
  

#final_geo_tx11 has all candidate level variables in addition to center and opo-level variables

final_geo_tx11<- final_geo_tx10 %>% 
  left_join(cand_var, by = "PX_ID")

```

```{r fix variables for STATA output}
#ctr_tx_ct_30, ctr_tx_ct_90, ctr_tx_rate_30, ctr_tx_rate_90
#ctr_s1_tx_prop, ctr_s2_tx_prop, ctr_s3_tx_prop, ctr_s4_tx_prop

final_geo_tx13 <- final_geo_tx11 %>% 
  mutate(CTR_TX_CT_30 = replace_na(CTR_TX_CT_30,0),
         CTR_TX_CT_90 = replace_na(CTR_TX_CT_90,0),
         CTR_TX_RATE_30 = replace_na(CTR_TX_RATE_30,0),
         CTR_TX_RATE_90 = replace_na(CTR_TX_RATE_90,0),
         CTR_S1_TX_Prop = replace_na(CTR_S1_TX_Prop,0),
         CTR_S2_TX_Prop = replace_na(CTR_S2_TX_Prop,0),
         CTR_S3_TX_Prop = replace_na(CTR_S3_TX_Prop,0),
           CTR_S4_TX_Prop = replace_na(CTR_S4_TX_Prop,0)) 

#look for any centers that had no listing before policy implementation
pre_post_ctr <- final_geo_tx13 %>% 
  select(CTR_CD, policy) %>% 
  filter(is.na(policy)==FALSE) %>% 
  distinct() %>% 
  group_by(CTR_CD) %>% 
  add_count(CTR_CD, name="has_both") %>% 
  select(CTR_CD, has_both) %>% 
  distinct() %>% 
  filter(has_both ==2) %>% 
  select(CTR_CD)

#only include candidates from centers that had listings both before and after policy implementation

final_geo_tx14 <- final_geo_tx13 %>% 
  filter(CTR_CD %in% pre_post_ctr$CTR_CD)

```

```{r add status 1A back to dataset}
final_geo_tx15 <- final_geo_tx14 %>%
  mutate(status_1a = ifelse(PX_ID %in% status_1a$PX_ID, "T","F"))
```

# Export dataset
```{r write_out_clean_file}
write_csv(final_geo_tx15, "final_sample.csv")
```
